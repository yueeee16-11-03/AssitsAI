rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================
    // 1. CÃC HÃ€M TIá»†N ÃCH (HELPER FUNCTIONS)
    // =========================================================

    // Kiá»ƒm tra user Ä‘Ã£ Ä‘Äƒng nháº­p
    function isSignedIn() {
      return request.auth != null;
    }

    // Kiá»ƒm tra cÃ³ pháº£i chÃ­nh chá»§ user Ä‘Ã³ khÃ´ng (cho User Profile)
    function isUser(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // Kiá»ƒm tra cÃ³ pháº£i Chá»§ gia Ä‘Ã¬nh (Owner)
    function isFamilyOwner(familyData) {
      return isSignedIn() && familyData.ownerId == request.auth.uid;
    }

    // Kiá»ƒm tra cÃ³ pháº£i ThÃ nh viÃªn gia Ä‘Ã¬nh (Member)
    // (Kiá»ƒm tra xem UID cÃ³ náº±m trong máº£y memberIds hay khÃ´ng)
    function isFamilyMember(familyData) {
      return isSignedIn() 
             && "memberIds" in familyData 
             && (request.auth.uid in familyData.memberIds);
    }

    // =========================================================
    // 2. RULES CHO USERS (CÃ NHÃ‚N)
    // =========================================================

    match /users/{userId} {
      // 1. Cho phÃ©p User Ä‘á»c/ghi profile cá»§a chÃ­nh mÃ¬nh
      allow read, write: if isUser(userId);
      
      // [Bá»” SUNG] Cho phÃ©p update familyIds khi xÃ³a family (tá»« family owner)
      // DÃ¹ng diff() Ä‘á»ƒ chá»‰ cho phÃ©p thay Ä‘á»•i familyIds
      allow update: if isSignedIn() 
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['familyIds', 'updatedAt']);

      // 2. Tá»° Äá»˜NG cho phÃ©p Ä‘á»c/ghi Táº¤T Cáº¢ subcollections bÃªn trong
      // (Bao gá»“m: transactions, habits, checkIns, budgets, wallets, notifications, recurringTransactions...)
      // DÃ¹ng cÃº phÃ¡p wildcard {document=**} Ä‘á»ƒ khÃ´ng cáº§n liá»‡t kÃª tá»«ng cÃ¡i.
      match /{document=**} {
        allow read, write: if isUser(userId);
      }
    }

    // =========================================================
    // 3. RULES CHO FAMILY (GIA ÄÃŒNH)
    // =========================================================

    match /families/{familyId} {
      
      // 3.1 QUYá»€N Äá»ŒC (READ) & TÃŒM KIáº¾M (LIST)
      // - Get: Äá»c 1 document cá»¥ thá»ƒ -> Chá»‰ thÃ nh viÃªn má»›i Ä‘á»c Ä‘Æ°á»£c.
      // - List: TÃ¬m kiáº¿m danh sÃ¡ch -> Cho phÃ©p tÃ¬m náº¿u document cÃ³ mÃ£ má»i (Äá»ƒ phá»¥c vá»¥ tÃ­nh nÄƒng Join) HOáº¶C lÃ  thÃ nh viÃªn.
      allow get: if isFamilyMember(resource.data);
      allow list: if resource.data.inviteCode != null || isFamilyMember(resource.data);

      // 3.2 QUYá»€N Táº O (CREATE)
      // - Báº¯t buá»™c: NgÆ°á»i táº¡o pháº£i set ownerId lÃ  chÃ­nh mÃ¬nh & tá»± thÃªm mÃ¬nh vÃ o memberIds.
      allow create: if isSignedIn()
                    && request.resource.data.ownerId == request.auth.uid
                    && request.resource.data.memberIds.hasAll([request.auth.uid]);

      // 3.3 QUYá»€N Cáº¬P NHáº¬T (UPDATE)
      // - Case 1: Owner cÃ³ toÃ n quyá»n sá»­a.
      // - Case 2: Member Ä‘Æ°á»£c sá»­a (Ä‘á»ƒ cáº­p nháº­t thÃ´ng tin), NHÆ¯NG KHÃ”NG ÄÆ¯á»¢C Ä‘á»•i Owner.
      // - Case 3: User KHÃ”NG cÃ³ trong memberIds cÅ© nhÆ°ng Sáº¼ cÃ³ trong memberIds má»›i (JOIN qua code)
      //   + Kiá»ƒm tra: UID khÃ´ng cÃ³ trong old data nhÆ°ng cÃ³ trong new data
      //   + Báº£o vá»‡: KhÃ´ng Ä‘Æ°á»£c thay Ä‘á»•i owner/code/name (chá»‰ add chÃ­nh mÃ¬nh)
      allow update: if isFamilyOwner(resource.data)
                    || (isFamilyMember(resource.data) && request.resource.data.ownerId == resource.data.ownerId)
                    || (!(request.auth.uid in resource.data.memberIds)
                        && request.auth.uid in request.resource.data.memberIds
                        && request.resource.data.ownerId == resource.data.ownerId
                        && request.resource.data.inviteCode == resource.data.inviteCode
                        && request.resource.data.name == resource.data.name);

      // 3.4 QUYá»€N XÃ“A (DELETE)
      // - Chá»‰ Owner má»›i Ä‘Æ°á»£c xÃ³a gia Ä‘Ã¬nh.
      // - DÃ¹ng resource.data thay vÃ¬ get() Ä‘á»ƒ trÃ¡nh lá»—i
      allow delete: if resource.data.ownerId == request.auth.uid;


      // --- SUBCOLLECTION: Family Transactions (Chi tiÃªu chung) ---
      match /transactions/{transactionId} {
         // Rule: Chá»‰ thÃ nh viÃªn cá»§a gia Ä‘Ã¬nh Ä‘Ã³ má»›i Ä‘Æ°á»£c xem/sá»­a/xoÃ¡ chi tiÃªu chung.
         // LÆ°u Ã½: HÃ m get() tá»‘n 1 lÆ°á»£t Ä‘á»c database Ä‘á»ƒ kiá»ƒm tra quyá»n tá»« document cha.
         allow read, write: if isFamilyMember(get(/databases/$(database)/documents/families/$(familyId)).data);
      }

      // --- SUBCOLLECTION: Family Members (ThÃ nh viÃªn gia Ä‘Ã¬nh) ---
      match /members/{memberId} {
         // Rule: Chá»‰ thÃ nh viÃªn cá»§a gia Ä‘Ã¬nh Ä‘Ã³ má»›i Ä‘Æ°á»£c xem, Owner Ä‘Æ°á»£c quáº£n lÃ½
         allow read: if isFamilyMember(resource.data);
      }
    }

    // =========================================================
    // 4. RULES CHO FAMILY_MEMBERS (ROOT LEVEL)
    // =========================================================
    match /family_members/{memberId} {
      
      // ğŸ†• LIST: Cho phÃ©p query members cá»§a family mÃ  user lÃ  thÃ nh viÃªn
      // FIX: ThÃªm allow list Ä‘á»ƒ cho phÃ©p getFamilyMembers() query
      allow list: if isSignedIn() && resource.data.familyId != null;
      
      // Create: Cho phÃ©p náº¿u user táº¡o member cho chÃ­nh mÃ¬nh HOáº¶C user lÃ  owner
      // FIX: ThÃªm null check Ä‘á»ƒ trÃ¡nh lá»—i getFamilyData
      allow create: if isSignedIn() 
                    && (request.resource.data.userId == request.auth.uid 
                        || (request.resource.data.familyId != null 
                            && isFamilyOwner(get(/databases/$(database)/documents/families/$(request.resource.data.familyId)).data)));
      
      // Read: User cÃ³ thá»ƒ Ä‘á»c members cá»§a family mÃ¬nh tham gia
      allow read: if isSignedIn() 
                  && (resource.data.familyId != null
                      && isFamilyMember(get(/databases/$(database)/documents/families/$(resource.data.familyId)).data));
      
      // Update: Chá»‰ owner/admin hoáº·c chÃ­nh user Ä‘Ã³ má»›i Ä‘Æ°á»£c update
      allow update: if isSignedIn() 
                    && (resource.data.familyId != null
                        && (isFamilyOwner(get(/databases/$(database)/documents/families/$(resource.data.familyId)).data)
                            || request.auth.uid == resource.data.userId));
      
      // Delete: Chá»‰ owner hoáº·c user Ä‘Ã³ má»›i Ä‘Æ°á»£c xÃ³a
      allow delete: if isSignedIn() 
                    && (resource.data.familyId != null
                        && (isFamilyOwner(get(/databases/$(database)/documents/families/$(resource.data.familyId)).data)
                            || request.auth.uid == resource.data.userId));
    }

    // =========================================================
    // 5. RULES CHO CHAT & MESSAGES
    // =========================================================

    // Lá»‹ch sá»­ chat (Danh sÃ¡ch cÃ¡c cuá»™c trÃ² chuyá»‡n)
    match /chatHistories/{chatId} {
      // Create: Cho phÃ©p náº¿u userId trong data gá»­i lÃªn lÃ  cá»§a mÃ¬nh
      allow create: if request.auth.uid == request.resource.data.userId;
      
      // Read/Update/Delete: Cho phÃ©p náº¿u data hiá»‡n táº¡i thuá»™c vá» mÃ¬nh
      allow read, update, delete: if request.auth.uid == resource.data.userId;
    }

    // Tin nháº¯n chi tiáº¿t bÃªn trong
    match /chatMessages/{messageId} {
      // Create: Chá»‰ Ä‘Æ°á»£c gá»­i tin nháº¯n dÆ°á»›i danh nghÄ©a cá»§a mÃ¬nh
      allow create: if request.auth.uid == request.resource.data.userId;
      
      // Read: Chá»‰ Ä‘á»c tin nháº¯n cá»§a mÃ¬nh
      allow read: if request.auth.uid == resource.data.userId;
    }
  }
}
